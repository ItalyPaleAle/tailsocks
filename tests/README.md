# E2E Tests

This folder contains end-to-end checks orchestrated by shell scripts.

## `e2e.sh`

Starts TailSocks with `go run .`, waits for a local SOCKS5 proxy, then verifies:

1. Host IP (`curl https://api.ipify.org`)
2. Proxied IP (`curl https://api.ipify.org --proxy socks5://127.0.0.1:5040`)
3. The two IPs are different

The script always runs with `--ephemeral=true` and always uses a temporary `--state-dir` that is deleted at the end.

### Required env vars

- `E2E_EXIT_NODE`: exit node selector (IP or MagicDNS base name)

### Optional env vars

- `E2E_SOCKS_HOST` (default: `127.0.0.1`)
- `E2E_SOCKS_PORT` (default: `5040`)
- `E2E_LOGIN_SERVER` (optional custom control server)
- `E2E_EXPECTED_PROXY_IP` (optional; if set, proxied IP must match this value)
- `E2E_AUTH_MODE` (`authkey` or `oauth2`, default: `authkey`)
- `E2E_IP_CHECK_URL` (default: `https://api.ipify.org`)
- `E2E_WAIT_TIMEOUT_SEC` (default: `90`)
- `E2E_WAIT_INTERVAL_SEC` (default: `1`)
- `E2E_HOSTNAME` (default: autogenerated `tailsocks-e2e-<timestamp>`)

### Auth mode: `authkey`

Provide one of:

- `E2E_TS_AUTHKEY`
- `TS_AUTHKEY`
- `TS_AUTH_KEY`

Example:

```sh
E2E_EXIT_NODE=home-server \
E2E_AUTH_MODE=authkey \
E2E_TS_AUTHKEY=tskey-auth-xxxxx \
bash tests/e2e.sh
```

### Auth mode: `oauth2`

Provide either:

1. Direct access token flow:
   - `E2E_TS_OAUTH_ACCESS_TOKEN`
   - `E2E_TS_OAUTH_TAG`
2. OAuth2 client credentials flow:
   - `E2E_TS_OAUTH_CLIENT_ID`
   - `E2E_TS_OAUTH_CLIENT_SECRET`
   - `E2E_TS_OAUTH_TAG`

Example:

```sh
E2E_EXIT_NODE=home-server \
E2E_AUTH_MODE=oauth2 \
E2E_TS_OAUTH_CLIENT_ID=... \
E2E_TS_OAUTH_CLIENT_SECRET=... \
E2E_TS_OAUTH_TAG=tag-name \
bash tests/e2e.sh
```

## GitHub Actions

The CI workflow (`.github/workflows/ci.yaml`) runs this script in an `e2e` matrix job for both auth modes:

- `authkey`
- `oauth2`

It also splits `TAILSOCKS_E2E_EXIT_NODE` by commas and runs the matrix for each exit node.

Configure these repository secrets:

- `TAILSOCKS_E2E_EXIT_NODE` (required; comma-separated list, for example `home-exit,office-exit`)
- `TAILSOCKS_E2E_LOGIN_SERVER` (optional)
- `TAILSOCKS_E2E_EXPECTED_PROXY_IP` (optional; when set, test enforces exact proxied IP match)
- `TAILSOCKS_E2E_TS_OAUTH_CLIENT_ID` (required; for GitHub OIDC token exchange)
- `TAILSOCKS_E2E_TS_OAUTH_AUDIENCE` (required; audience for GitHub OIDC token)
- `TAILSOCKS_E2E_TS_OAUTH_TAG` (required; used to create tagged auth keys)

In CI, auth is fully federated:

- `authkey` matrix jobs create a short-lived auth key from the exchanged Tailscale access token.
- `oauth2` matrix jobs pass the exchanged Tailscale access token directly (`TS_OAUTH_ACCESS_TOKEN` + `TS_OAUTH_TAG`).
